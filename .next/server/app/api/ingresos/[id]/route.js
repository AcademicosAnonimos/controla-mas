"use strict";(()=>{var r={};r.id=223,r.ids=[223],r.modules={517:r=>{r.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8678:r=>{r.exports=import("pg")},2059:(r,e,o)=>{o.a(r,async(r,i)=>{try{o.r(e),o.d(e,{headerHooks:()=>l,originalPathname:()=>_,requestAsyncStorage:()=>E,routeModule:()=>u,serverHooks:()=>c,staticGenerationAsyncStorage:()=>d,staticGenerationBailout:()=>g});var a=o(884),t=o(6132),n=o(9061),s=r([n]);n=(s.then?(await s)():s)[0];let u=new a.AppRouteRouteModule({definition:{kind:t.x.APP_ROUTE,page:"/api/ingresos/[id]/route",pathname:"/api/ingresos/[id]",filename:"route",bundlePath:"app/api/ingresos/[id]/route"},resolvedPagePath:"C:\\Users\\User\\Documents\\PROYECTOS\\BASE DE DATOS - Facultad\\ProbandoReact\\ControlaMas\\app\\api\\ingresos\\[id]\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:E,staticGenerationAsyncStorage:d,serverHooks:c,headerHooks:l,staticGenerationBailout:g}=u,_="/api/ingresos/[id]/route";i()}catch(r){i(r)}})},9061:(r,e,o)=>{o.a(r,async(r,i)=>{try{o.r(e),o.d(e,{DELETE:()=>DELETE,GET:()=>GET,PUT:()=>PUT,dynamic:()=>s});var a=o(5798),t=o(8818),n=r([t]);t=(n.then?(await n)():n)[0];let s="force-dynamic";async function GET(r,{params:e}){try{let r=await t.Z.query(`SELECT i.*, u.nombre as usuario_nombre 
       FROM Ingreso i 
       JOIN Usuario u ON i.id_usuario = u.id_usuario 
       WHERE i.id_ingreso = $1`,[e.id]);if(0===r.rows.length)return a.Z.json({error:"Ingreso no encontrado"},{status:404});return a.Z.json(r.rows[0])}catch(r){return a.Z.json({error:"Error al obtener ingreso"},{status:500})}}async function PUT(r,{params:e}){let o=await t.Z.connect();try{await o.query("BEGIN");let{descripcion:i,fecha_ingreso:t,monto:n,id_usuario:s}=await r.json(),u=await o.query("SELECT monto, id_usuario FROM Ingreso WHERE id_ingreso = $1",[e.id]);if(0===u.rows.length)throw Error("Ingreso no encontrado");let E=u.rows[0].monto,d=u.rows[0].id_usuario,c=await o.query(`UPDATE Ingreso 
       SET descripcion = $1, fecha_ingreso = $2, monto = $3, id_usuario = $4 
       WHERE id_ingreso = $5 RETURNING *`,[i,t,n,s,e.id]);if(0===c.rows.length)throw Error("Ingreso no encontrado");if(d===s){let r=n-E;await o.query("UPDATE Usuario SET monto_disponible = monto_disponible + $1 WHERE id_usuario = $2",[r,s])}else await o.query("UPDATE Usuario SET monto_disponible = monto_disponible - $1 WHERE id_usuario = $2",[E,d]),await o.query("UPDATE Usuario SET monto_disponible = monto_disponible + $1 WHERE id_usuario = $2",[n,s]);return await o.query("COMMIT"),a.Z.json(c.rows[0])}catch(r){return await o.query("ROLLBACK"),a.Z.json({error:r instanceof Error?r.message:"Error al actualizar ingreso"},{status:500})}finally{o.release()}}async function DELETE(r,{params:e}){let o=await t.Z.connect();try{await o.query("BEGIN");let r=await o.query("SELECT monto, id_usuario FROM Ingreso WHERE id_ingreso = $1",[e.id]);if(0===r.rows.length)return a.Z.json({error:"Ingreso no encontrado"},{status:404});let i=r.rows[0];return await o.query("DELETE FROM Ingreso WHERE id_ingreso = $1 RETURNING *",[e.id]),await o.query("UPDATE Usuario SET monto_disponible = monto_disponible - $1 WHERE id_usuario = $2",[i.monto,i.id_usuario]),await o.query("COMMIT"),a.Z.json({message:"Ingreso eliminado correctamente"})}catch(r){return await o.query("ROLLBACK"),a.Z.json({error:"Error al eliminar ingreso"},{status:500})}finally{o.release()}}i()}catch(r){i(r)}})},8818:(r,e,o)=>{o.a(r,async(r,i)=>{try{o.d(e,{Z:()=>s});var a=o(8678),t=r([a]);a=(t.then?(await t)():t)[0];let n=new a.Pool({connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1}}),s=n;i()}catch(r){i(r)}})}};var e=require("../../../../webpack-runtime.js");e.C(r);var __webpack_exec__=r=>e(e.s=r),o=e.X(0,[997],()=>__webpack_exec__(2059));module.exports=o})();