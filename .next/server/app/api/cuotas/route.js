"use strict";(()=>{var a={};a.id=647,a.ids=[647],a.modules={517:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8678:a=>{a.exports=import("pg")},2684:(a,t,o)=>{o.a(a,async(a,e)=>{try{o.r(t),o.d(t,{headerHooks:()=>p,originalPathname:()=>l,requestAsyncStorage:()=>u,routeModule:()=>c,serverHooks:()=>_,staticGenerationAsyncStorage:()=>d,staticGenerationBailout:()=>g});var r=o(884),s=o(6132),i=o(3397),n=a([i]);i=(n.then?(await n)():n)[0];let c=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/cuotas/route",pathname:"/api/cuotas",filename:"route",bundlePath:"app/api/cuotas/route"},resolvedPagePath:"C:\\Users\\User\\Documents\\PROYECTOS\\BASE DE DATOS - Facultad\\ProbandoReact\\ControlaMas\\app\\api\\cuotas\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:u,staticGenerationAsyncStorage:d,serverHooks:_,headerHooks:p,staticGenerationBailout:g}=c,l="/api/cuotas/route";e()}catch(a){e(a)}})},3397:(a,t,o)=>{o.a(a,async(a,e)=>{try{o.r(t),o.d(t,{GET:()=>GET,PUT:()=>PUT,dynamic:()=>n});var r=o(5798),s=o(8818),i=a([s]);s=(i.then?(await i)():i)[0];let n="force-dynamic";async function GET(a){try{let{searchParams:t}=new URL(a.url),o=t.get("id_usuario"),e=`
      SELECT c.*, g.descripcion as descripcion_gasto, e.descripcion as estado,
             g.monto_total, tg.descripcion as tipo_gasto
      FROM Cuota c
      JOIN Gasto g ON c.id_gasto = g.id_gasto
      JOIN Estado e ON c.id_estado = e.id_estado
      JOIN Tipo_gasto tg ON g.id_tipo_gasto = tg.id_tipo_gasto
    `,i=[];o&&(e+=" WHERE g.id_usuario = $1",i.push(o)),e+=" ORDER BY c.fecha_vencimiento_cuota ASC";let n=await s.Z.query(e,i);return r.Z.json(n.rows)}catch(a){return r.Z.json({error:"Error al obtener cuotas"},{status:500})}}async function PUT(a){let t=await s.Z.connect();try{let{id_cuota:o,accion:e}=await a.json();if("pagar"===e){await t.query("BEGIN");let a=await t.query(`SELECT c.*, g.monto_total, g.id_usuario, g.descripcion
         FROM Cuota c
         JOIN Gasto g ON c.id_gasto = g.id_gasto
         WHERE c.id_cuota = $1`,[o]);if(0===a.rows.length)throw Error("Cuota no encontrada");let e=a.rows[0],s=e.monto_total/e.total_cuotas,i=await t.query(`INSERT INTO Pago (importe_a_pagar, fecha_pago, id_gasto) 
         VALUES ($1, CURRENT_DATE, $2) RETURNING *`,[s,e.id_gasto]),n=i.rows[0];return await t.query("UPDATE Cuota SET id_estado = 2 WHERE id_cuota = $1",[o]),await t.query("UPDATE Usuario SET monto_disponible = monto_disponible - $1 WHERE id_usuario = $2",[s,e.id_usuario]),await t.query("COMMIT"),r.Z.json({message:"Cuota pagada correctamente",pago:n})}return r.Z.json({error:"Acci\xf3n no v\xe1lida"},{status:400})}catch(a){return await t.query("ROLLBACK"),r.Z.json({error:a instanceof Error?a.message:"Error al procesar cuota"},{status:500})}finally{t.release()}}e()}catch(a){e(a)}})},8818:(a,t,o)=>{o.a(a,async(a,e)=>{try{o.d(t,{Z:()=>n});var r=o(8678),s=a([r]);r=(s.then?(await s)():s)[0];let i=new r.Pool({connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1}}),n=i;e()}catch(a){e(a)}})}};var t=require("../../../webpack-runtime.js");t.C(a);var __webpack_exec__=a=>t(t.s=a),o=t.X(0,[997],()=>__webpack_exec__(2684));module.exports=o})();