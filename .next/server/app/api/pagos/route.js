"use strict";(()=>{var a={};a.id=719,a.ids=[719],a.modules={517:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8678:a=>{a.exports=import("pg")},4645:(a,o,e)=>{e.a(a,async(a,r)=>{try{e.r(o),e.d(o,{headerHooks:()=>u,originalPathname:()=>m,requestAsyncStorage:()=>n,routeModule:()=>d,serverHooks:()=>_,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>c});var i=e(884),t=e(6132),p=e(5908),s=a([p]);p=(s.then?(await s)():s)[0];let d=new i.AppRouteRouteModule({definition:{kind:t.x.APP_ROUTE,page:"/api/pagos/route",pathname:"/api/pagos",filename:"route",bundlePath:"app/api/pagos/route"},resolvedPagePath:"C:\\Users\\User\\Documents\\PROYECTOS\\BASE DE DATOS - Facultad\\ProbandoReact\\ControlaMas\\app\\api\\pagos\\route.ts",nextConfigOutput:"",userland:p}),{requestAsyncStorage:n,staticGenerationAsyncStorage:g,serverHooks:_,headerHooks:u,staticGenerationBailout:c}=d,m="/api/pagos/route";r()}catch(a){r(a)}})},5908:(a,o,e)=>{e.a(a,async(a,r)=>{try{e.r(o),e.d(o,{GET:()=>GET,POST:()=>POST,dynamic:()=>s});var i=e(5798),t=e(8818),p=a([t]);t=(p.then?(await p)():p)[0];let s="force-dynamic";async function GET(a){try{let{searchParams:o}=new URL(a.url),e=o.get("id_usuario"),r=`
      SELECT p.*, g.descripcion as descripcion_gasto, 
             array_agg(json_build_object(
               'id_medio_pago', mp.id_medio_pago,
               'medio_pago', mp.medio_pago,
               'importe_pagado', pxmp.importe_pagado
             )) as medios_pago
      FROM Pago p
      JOIN Gasto g ON p.id_gasto = g.id_gasto
      LEFT JOIN Pagosxmedio_pago pxmp ON p.id_pago = pxmp.id_pago
      LEFT JOIN Medio_pago mp ON pxmp.id_medio_pago = mp.id_medio_pago
    `,p=[];e&&(r+=" WHERE g.id_usuario = $1",p.push(e)),r+=" GROUP BY p.id_pago, g.descripcion ORDER BY p.fecha_pago DESC";let s=await t.Z.query(r,p),d=s.rows.map(a=>({...a,medios_pago:a.medios_pago.filter(a=>null!==a.id_medio_pago)}));return i.Z.json(d)}catch(a){return console.error("Error al obtener pagos:",a),i.Z.json({error:"Error al obtener pagos"},{status:500})}}async function POST(a){let o=await t.Z.connect();try{await o.query("BEGIN");let{importe_a_pagar:e,fecha_pago:r,id_gasto:t,medios_pago:p,mes_impacto:s,a√±o_impacto:d}=await a.json();if(!e||e<=0)throw Error("Importe a pagar debe ser mayor a 0");if(!t)throw Error("Gasto es requerido");let n=await o.query(`SELECT g.*, u.id_usuario 
       FROM Gasto g 
       JOIN Usuario u ON g.id_usuario = u.id_usuario 
       WHERE g.id_gasto = $1`,[t]);if(0===n.rows.length)throw Error("Gasto no encontrado");let g=n.rows[0],_=await o.query(`INSERT INTO Pago (importe_a_pagar, fecha_pago, id_gasto) 
       VALUES ($1, $2, $3) RETURNING *`,[e,r||new Date().toISOString().split("T")[0],t]),u=_.rows[0];if(p&&p.length>0)for(let a of p)await o.query(`INSERT INTO Pagosxmedio_pago (id_pago, id_medio_pago, importe_pagado) 
           VALUES ($1, $2, $3)`,[u.id_pago,a.id_medio_pago,a.importe_pagado]),3===a.id_medio_pago&&s&&d&&await o.query(`INSERT INTO Impacta (id_pago, id_medio_pago, mes, a\xf1o) 
             VALUES ($1, $2, $3, $4)`,[u.id_pago,a.id_medio_pago,s,d]);return await o.query("UPDATE Usuario SET monto_disponible = monto_disponible - $1 WHERE id_usuario = $2",[e,g.id_usuario]),await o.query("COMMIT"),i.Z.json(u)}catch(a){return await o.query("ROLLBACK"),i.Z.json({error:a instanceof Error?a.message:"Error al crear pago"},{status:500})}finally{o.release()}}r()}catch(a){r(a)}})},8818:(a,o,e)=>{e.a(a,async(a,r)=>{try{e.d(o,{Z:()=>s});var i=e(8678),t=a([i]);i=(t.then?(await t)():t)[0];let p=new i.Pool({connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1}}),s=p;r()}catch(a){r(a)}})}};var o=require("../../../webpack-runtime.js");o.C(a);var __webpack_exec__=a=>o(o.s=a),e=o.X(0,[997],()=>__webpack_exec__(4645));module.exports=e})();